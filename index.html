<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電卓ノート（履歴機能・ページ機能付き）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Theme Variables --- */
        :root {
            --bg-color: #e8eef3;
            --text-color: #1a202c;
            --calculator-bg: #ffffff;
            --display-bg: #f7fafc;
            --button-bg: #fdfdfd;
            --button-hover-bg: #f0f4f8;
            --button-text-color: #2d3748;
            --operator-button-bg: #3182ce;
            --operator-button-text: #ffffff;
            --operator-button-hover-bg: #2b6cb0;
            --special-button-bg: #e2e8f0;
            --special-button-hover-bg: #cbd5e0;
            --history-bg: #ffffff;
            --history-border: #e2e8f0;
            --shadow-color: rgba(66, 84, 102, 0.15);
            --pagination-button-bg: #e2e8f0;
            --pagination-button-hover-bg: #cbd5e0;
            --pagination-button-disabled-bg: #f7fafc;
            --pagination-button-disabled-color: #a0aec0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a202c;
                --text-color: #e2e8f0;
                --calculator-bg: #2d3748;
                --display-bg: #1f2733;
                --button-bg: #4a5568;
                --button-hover-bg: #5a667a;
                --button-text-color: #ffffff;
                --operator-button-bg: #4299e1;
                --operator-button-text: #ffffff;
                --operator-button-hover-bg: #3182ce;
                --special-button-bg: #718096;
                --special-button-hover-bg: #5a667a;
                --history-bg: #2d3748;
                --history-border: #4a5568;
                --shadow-color: rgba(0, 0, 0, 0.25);
                --pagination-button-bg: #718096;
                --pagination-button-hover-bg: #5a667a;
                --pagination-button-disabled-bg: #1f2733;
                --pagination-button-disabled-color: #718096;
            }
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* --- Calculator Styles --- */
        .calculator {
            width: 100%;
            max-width: 400px;
            background-color: var(--calculator-bg);
            border-radius: 24px;
            box-shadow: 0 12px 30px var(--shadow-color);
            padding: 25px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }

        .display {
            background-color: var(--display-bg);
            color: var(--text-color);
            border-radius: 12px;
            padding: 20px;
            text-align: right;
            margin-bottom: 25px;
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid var(--history-border);
        }
        
        .expression {
            font-size: 1.3em;
            color: var(--text-color);
            opacity: 0.7;
            height: 28px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none; /* Firefox */
        }
        .expression::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }


        .result {
            font-size: 3em;
            font-weight: 500;
            word-wrap: break-word;
            min-height: 50px;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 15px;
        }

        .button {
            border: none;
            background-color: var(--button-bg);
            color: var(--button-text-color);
            font-size: 1.5em;
            padding: 18px 0;
            border-radius: 18px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        .button:hover {
            background-color: var(--button-hover-bg);
        }

        .button:active {
            transform: scale(0.96);
            box-shadow: none;
        }

        .button.operator {
            background-color: var(--operator-button-bg);
            color: var(--operator-button-text);
        }

        .button.operator:hover {
            background-color: var(--operator-button-hover-bg);
        }
        
        .button.special {
            background-color: var(--special-button-bg);
            color: var(--button-text-color);
        }

        .button.special:hover {
            background-color: var(--special-button-hover-bg);
        }
        
        /* --- History Styles --- */
        .history-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .history-container h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        #history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: var(--history-bg);
            border: 1px solid var(--history-border);
            border-radius: 10px;
            height: 480px;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s;
        }

        #history-list li {
            padding: 8px;
            border-bottom: 1px solid var(--history-border);
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            word-break: break-all;
        }
        
        #history-list li:last-child {
            border-bottom: none;
        }
        
        .history-expression {
            font-size: 0.9em;
            opacity: 0.7;
        }

        #clear-history {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 12px;
            background-color: var(--special-button-bg);
            color: var(--button-text-color);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        #clear-history:hover {
            background-color: var(--special-button-hover-bg);
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .page-btn {
            background-color: var(--pagination-button-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn svg {
            color: var(--text-color);
        }

        .page-btn:hover {
            background-color: var(--pagination-button-hover-bg);
        }
        
        .page-btn:disabled {
            background-color: var(--pagination-button-disabled-bg);
            cursor: not-allowed;
        }
        
        .page-btn:disabled svg {
            color: var(--pagination-button-disabled-color);
        }

        #page-info {
            font-size: 1em;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="calculator">
        <div class="display">
            <div class="expression" id="expression-display">&nbsp;</div>
            <div class="result" id="result-display">0</div>
        </div>
        <div class="buttons">
            <!-- Row 1: Functions -->
            <button class="button special" data-action="parenthesis" data-value="(">(</button>
            <button class="button special" data-action="parenthesis" data-value=")">)</button>
            <button class="button special" data-action="sqrt">√</button>
            <button class="button special" data-action="backspace">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16">
                    <path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"/>
                    <path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"/>
                </svg>
            </button>
            
            <!-- Row 2: Functions & Constants -->
            <button class="button special" data-action="constant" data-value="π">π</button>
            <button class="button special" data-action="constant" data-value="e">e</button>
            <button class="button special" data-action="clear">C</button>
            <button class="button special" data-action="operator" data-value="%">%</button>
            
            <!-- Row 3: Numpad -->
            <button class="button" data-action="number" data-value="7">7</button>
            <button class="button" data-action="number" data-value="8">8</button>
            <button class="button" data-action="number" data-value="9">9</button>
            <button class="button operator" data-action="operator" data-value="÷">÷</button>
            
            <!-- Row 4: Numpad -->
            <button class="button" data-action="number" data-value="4">4</button>
            <button class="button" data-action="number" data-value="5">5</button>
            <button class="button" data-action="number" data-value="6">6</button>
            <button class="button operator" data-action="operator" data-value="×">×</button>
            
            <!-- Row 5: Numpad -->
            <button class="button" data-action="number" data-value="1">1</button>
            <button class="button" data-action="number" data-value="2">2</button>
            <button class="button" data-action="number" data-value="3">3</button>
            <button class="button operator" data-action="operator" data-value="−">−</button>

            <!-- Row 6: Numpad -->
            <button class="button" data-action="number" data-value="0">0</button>
            <button class="button" data-action="number" data-value=".">.</button>
            <button class="button operator" data-action="calculate" data-value="=">=</button>
            <button class="button operator" data-action="operator" data-value="+">+</button>
        </div>
    </div>
    
    <div class="history-container">
        <h2>計算履歴</h2>
        <div class="pagination">
            <button class="page-btn" id="prev-page">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                </svg>
            </button>
            <span id="page-info">1 / 1</span>
            <button class="page-btn" id="next-page">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </button>
        </div>
        <ul id="history-list"></ul>
        <button id="clear-history">履歴を消去</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultDisplay = document.getElementById('result-display');
            const expressionDisplay = document.getElementById('expression-display');
            const historyList = document.getElementById('history-list');
            const clearHistoryBtn = document.getElementById('clear-history');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');

            let expression = '';
            let isResultShown = false;
            let lastOperation = null;

            // --- Pagination State ---
            let currentPage = 1;
            const itemsPerPage = 100;

            // --- Core Functions ---

            function updateDisplay() {
                resultDisplay.textContent = expression ? formatNumber(expression) : '0';
            }
            
            function updateExpressionDisplay(text) {
                 expressionDisplay.textContent = text;
            }

            function formatNumber(numStr) {
                if (typeof numStr !== 'string' || numStr === '' || numStr === 'Error') return numStr;

                try {
                    const num = parseFloat(numStr.replace(/,/g, ''));
                    if (isNaN(num)) return numStr;

                    if (Math.abs(num) >= 1e21) {
                         return num.toExponential(2);
                    }
                    
                    const parts = numStr.split('.');
                    const integerPart = parts[0];
                    const decimalPart = parts[1];

                    const formattedIntegerPart = parseFloat(integerPart).toLocaleString('en-US', { maximumFractionDigits: 20 });
                    
                    return decimalPart != null ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;

                } catch(e) {
                    return numStr;
                }
            }

            function handleAction(action, value) {
                if (isResultShown && (action === 'number' || action === 'constant' || action === 'parenthesis')) {
                    expression = '';
                    isResultShown = false;
                }
                if (isResultShown && action === 'operator') {
                    isResultShown = false;
                }

                switch (action) {
                    case 'number':
                    case 'parenthesis':
                    case 'operator':
                        expression += value;
                        break;
                    case 'constant':
                        expression += value === 'π' ? String(Math.PI) : String(Math.E);
                        break;
                    case 'clear':
                        expression = '';
                        lastOperation = null;
                        updateExpressionDisplay(' ');
                        break;
                    case 'backspace':
                        expression = expression.slice(0, -1);
                        break;
                    case 'sqrt':
                        try {
                            const evalResult = evaluateExpression(expression);
                            expression = String(Math.sqrt(evalResult));
                        } catch {
                            expression = 'Error';
                        }
                        isResultShown = true;
                        break;
                    case 'calculate':
                        calculate();
                        break;
                }
                 updateDisplay();
            }
            
            function evaluateExpression(exp) {
                if (!exp) return 0;
                const evalFriendlyExp = exp
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/−/g, '-')
                    .replace(/%/g, '/100');

                return new Function('return ' + evalFriendlyExp)();
            }

            function calculate() {
                if (isResultShown && lastOperation) {
                    const currentResult = expression;
                    const repeatExpression = `${formatNumber(currentResult)} ${lastOperation.symbol} ${lastOperation.operandValue}`;
                    
                    try {
                        const result = evaluateExpression(currentResult + lastOperation.operator + lastOperation.operandValue);
                        saveToHistory(repeatExpression, result);
                        updateExpressionDisplay(repeatExpression + ' =');
                        expression = String(result);
                        isResultShown = true;
                    } catch {
                        expression = 'Error';
                        isResultShown = true;
                    }
                    updateDisplay();
                    return;
                }
                
                if (expression === '') return;
                
                const expressionToEvaluate = expression;
                try {
                    const result = evaluateExpression(expressionToEvaluate);
                    
                    const match = expressionToEvaluate.match(/([+\-−×÷])([^+\-−×÷]+)$/);
                    if (match) {
                        lastOperation = {
                            symbol: match[1],
                            operator: match[1].replace('×', '*').replace('÷', '/').replace('−', '-'),
                            operandValue: match[2]
                        };
                    } else {
                        lastOperation = null;
                    }
                    
                    saveToHistory(`${expressionToEvaluate} =`, result);
                    updateExpressionDisplay(`${expressionToEvaluate} =`);
                    expression = String(result);
                    isResultShown = true;

                } catch (error) {
                    expression = 'Error';
                    isResultShown = true;
                    lastOperation = null;
                }
                updateDisplay();
            }
            
            // --- History and Pagination Functions ---

            function saveToHistory(expr, res) {
                let history = JSON.parse(localStorage.getItem('calculatorHistory')) || [];
                history.unshift({ expression: expr, result: formatNumber(String(res)) });
                localStorage.setItem('calculatorHistory', JSON.stringify(history));
                currentPage = 1;
                loadHistory();
            }

            function loadHistory() {
                let history = JSON.parse(localStorage.getItem('calculatorHistory')) || [];
                historyList.innerHTML = '';

                const totalItems = history.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
                currentPage = Math.min(currentPage, totalPages);

                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedItems = history.slice(start, end);

                paginatedItems.forEach(item => {
                    const li = document.createElement('li');
                    const exprSpan = document.createElement('span');
                    exprSpan.className = 'history-expression';
                    exprSpan.textContent = item.expression;
                    const resSpan = document.createElement('span');
                    resSpan.textContent = item.result;
                    li.appendChild(exprSpan);
                    li.appendChild(resSpan);
                    historyList.appendChild(li);
                });
                
                updatePaginationControls(totalPages);
            }
            
            function updatePaginationControls(totalPages) {
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            }

            function clearHistory() {
                localStorage.removeItem('calculatorHistory');
                currentPage = 1;
                loadHistory();
            }

            // --- Event Listeners ---

            document.querySelector('.buttons').addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;
                
                const { action, value } = button.dataset;
                if (action) {
                    handleAction(action, value);
                }
            });
            
            window.addEventListener('keydown', (event) => {
                const key = event.key;
                let button;

                if (key >= '0' && key <= '9' || key === '.') {
                    button = document.querySelector(`.button[data-action="number"][data-value="${key}"]`);
                } else if (key === '+') {
                    button = document.querySelector(`.button[data-action="operator"][data-value="+"]`);
                } else if (key === '-') {
                    button = document.querySelector(`.button[data-action="operator"][data-value="−"]`);
                } else if (key === '*') {
                    button = document.querySelector(`.button[data-action="operator"][data-value="×"]`);
                } else if (key === '/') {
                    event.preventDefault();
                    button = document.querySelector(`.button[data-action="operator"][data-value="÷"]`);
                } else if (key === '%') {
                    button = document.querySelector(`.button[data-action="operator"][data-value="%"]`);
                } else if (key === 'Enter' || key === '=') {
                    event.preventDefault();
                    button = document.querySelector('.button[data-action="calculate"]');
                } else if (key === 'Backspace') {
                    button = document.querySelector('.button[data-action="backspace"]');
                } else if (key.toLowerCase() === 'c' || key === 'Escape') {
                    button = document.querySelector('.button[data-action="clear"]');
                } else if (key === '(' || key === ')') {
                    button = document.querySelector(`.button[data-action="parenthesis"][data-value="${key}"]`);
                }

                if (button) {
                    button.click();
                }
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadHistory();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const history = JSON.parse(localStorage.getItem('calculatorHistory')) || [];
                const totalPages = Math.ceil(history.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    loadHistory();
                }
            });
            
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // --- Initial Load ---
            loadHistory();
            updateDisplay();
        });
    </script>
</body>
</html>
